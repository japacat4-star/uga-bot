import 'dotenv/config';
import {
  Client,
  GatewayIntentBits,
  EmbedBuilder,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
  ModalBuilder,
  TextInputBuilder,
  TextInputStyle,
  Events,
} from 'discord.js';

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
  ],
});

const eventosAtivos = new Map();

// âœ… Quando o bot inicia
client.once(Events.ClientReady, async () => {
  console.log(`ğŸ¤– Bot conectado como ${client.user.tag}!`);

  // Canal de recrutamento
  const recrutamentoChannel = client.channels.cache.find(c => c.name === 'ğŸ“‹ãƒ»recrutamento');
  if (recrutamentoChannel) {
    const embed = new EmbedBuilder()
      .setColor('#ffcc00')
      .setTitle('ğŸ“‹ Sistema de Recrutamento MLC')
      .setDescription('Clique no botÃ£o abaixo para preencher seu formulÃ¡rio e entrar para a **MLC**!');
    const button = new ButtonBuilder()
      .setCustomId('abrir_formulario')
      .setLabel('ğŸ“„ Abrir FormulÃ¡rio')
      .setStyle(ButtonStyle.Primary);
    recrutamentoChannel.send({ embeds: [embed], components: [new ActionRowBuilder().addComponents(button)] });
  }

  // Canal de criar evento
  const criarEventoChannel = client.channels.cache.find(c => c.name === 'ğŸ“–ãƒ»criar-evento');
  if (criarEventoChannel) {
    const embed = new EmbedBuilder()
      .setColor('#ffcc00')
      .setTitle('ğŸ¯ Sistema de Eventos MLC')
      .setDescription('Apenas **Superiores** podem criar eventos. Clique abaixo para abrir o formulÃ¡rio de criaÃ§Ã£o.');
    const button = new ButtonBuilder()
      .setCustomId('criar_evento')
      .setLabel('ğŸ“ Criar Evento')
      .setStyle(ButtonStyle.Success);
    criarEventoChannel.send({ embeds: [embed], components: [new ActionRowBuilder().addComponents(button)] });
  }
});

// âœ… Logs de entrada/saÃ­da
client.on(Events.GuildMemberAdd, async (member) => {
  const canal = member.guild.channels.cache.find(c => c.name === 'logs-entrada');
  if (canal) {
    const embed = new EmbedBuilder()
      .setColor('#ffcc00')
      .setTitle('ğŸšª Novo membro entrou!')
      .setDescription(`ğŸ‘¤ ${member.user.tag} entrou no servidor!`)
      .setThumbnail(member.user.displayAvatarURL())
      .setTimestamp();
    canal.send({ embeds: [embed] });
  }
});

client.on(Events.GuildMemberRemove, async (member) => {
  const canal = member.guild.channels.cache.find(c => c.name === 'logs-saida');
  if (canal) {
    const embed = new EmbedBuilder()
      .setColor('#ffcc00')
      .setTitle('ğŸšª Membro saiu!')
      .setDescription(`ğŸ‘‹ ${member.user.tag} saiu do servidor.`)
      .setThumbnail(member.user.displayAvatarURL())
      .setTimestamp();
    canal.send({ embeds: [embed] });
  }
});

// âœ… InteraÃ§Ãµes do bot
client.on(Events.InteractionCreate, async (interaction) => {

  // --- CRIAÃ‡ÃƒO DE EVENTO (SUPERIOR) ---
  if (interaction.isButton() && interaction.customId === 'criar_evento') {
    if (!interaction.member.roles.cache.some(r => r.name === 'Superior')) {
      return interaction.reply({ content: 'ğŸš« Apenas Superiores podem criar eventos.', ephemeral: true });
    }

    const modal = new ModalBuilder()
      .setCustomId('form_criar_evento')
      .setTitle('ğŸ“ Criar Novo Evento');

    const tipo = new TextInputBuilder().setCustomId('tipo').setLabel('Tipo de AÃ§Ã£o').setStyle(TextInputStyle.Short).setRequired(true);
    const horario = new TextInputBuilder().setCustomId('horario').setLabel('HorÃ¡rio de InÃ­cio').setStyle(TextInputStyle.Short).setRequired(true);
    const vagas = new TextInputBuilder().setCustomId('vagas').setLabel('Quantidade de vagas').setStyle(TextInputStyle.Short).setRequired(true);
    const desc = new TextInputBuilder().setCustomId('descricao').setLabel('DescriÃ§Ã£o do Evento').setStyle(TextInputStyle.Paragraph).setRequired(true);

    modal.addComponents(
      new ActionRowBuilder().addComponents(tipo),
      new ActionRowBuilder().addComponents(horario),
      new ActionRowBuilder().addComponents(vagas),
      new ActionRowBuilder().addComponents(desc)
    );

    await interaction.showModal(modal);
  }

  // --- FORMULÃRIO DE EVENTO ENVIADO ---
  if (interaction.isModalSubmit() && interaction.customId === 'form_criar_evento') {
    const tipo = interaction.fields.getTextInputValue('tipo');
    const horario = interaction.fields.getTextInputValue('horario');
    const vagas = parseInt(interaction.fields.getTextInputValue('vagas'));
    const descricao = interaction.fields.getTextInputValue('descricao');

    const canalEventos = interaction.guild.channels.cache.find(c => c.name === 'ğŸ“–ãƒ»eventos-mlc');
    if (!canalEventos) return interaction.reply({ content: 'âŒ Canal de eventos nÃ£o encontrado.', ephemeral: true });

    const embed = new EmbedBuilder()
      .setColor('#ffcc00')
      .setTitle(`ğŸ“– Novo Evento MLC`)
      .setDescription(`**Tipo:** ${tipo}\n**HorÃ¡rio:** ${horario}\n**DescriÃ§Ã£o:** ${descricao}\n**Vagas:** ${vagas}`)
      .addFields({ name: 'ğŸ‘¥ Participantes:', value: 'Nenhum ainda.' })
      .setFooter({ text: `Criado por ${interaction.user.tag}` })
      .setTimestamp();

    const entrar = new ButtonBuilder().setCustomId(`entrar_${Date.now()}`).setLabel('âœ… Participar do Evento').setStyle(ButtonStyle.Primary);
    const iniciar = new ButtonBuilder().setCustomId(`iniciar_${Date.now()}`).setLabel('â–¶ï¸ Iniciar').setStyle(ButtonStyle.Success);
    const pausar = new ButtonBuilder().setCustomId(`pausar_${Date.now()}`).setLabel('â¸ï¸ Pausar').setStyle(ButtonStyle.Secondary);
    const finalizar = new ButtonBuilder().setCustomId(`finalizar_${Date.now()}`).setLabel('ğŸ Finalizar').setStyle(ButtonStyle.Danger);

    const msg = await canalEventos.send({
      embeds: [embed],
      components: [new ActionRowBuilder().addComponents(entrar), new ActionRowBuilder().addComponents(iniciar, pausar, finalizar)],
    });

    eventosAtivos.set(msg.id, {
      criador: interaction.user.id,
      tipo,
      horario,
      vagas,
      descricao,
      participantes: [],
      pausas: [],
      iniciado: false,
      tempoInicio: null,
    });

    await interaction.reply({ content: 'âœ… Evento criado com sucesso em ğŸ“–ãƒ»eventos-mlc!', ephemeral: true });
  }

  // --- PARTICIPAÃ‡ÃƒO DE MLC ---
  if (interaction.isButton() && interaction.customId.startsWith('entrar_')) {
    const evento = eventosAtivos.get(interaction.message.id);
    if (!evento) return interaction.reply({ content: 'âŒ Evento nÃ£o encontrado.', ephemeral: true });

    if (!interaction.member.roles.cache.some(r => r.name === 'MLC')) {
      return interaction.reply({ content: 'ğŸš« Apenas membros da MLC podem participar.', ephemeral: true });
    }

    const nick = interaction.member.displayName;
    if (evento.participantes.includes(nick)) {
      return interaction.reply({ content: 'âš ï¸ VocÃª jÃ¡ estÃ¡ inscrito neste evento.', ephemeral: true });
    }

    if (evento.participantes.length >= evento.vagas) {
      return interaction.reply({ content: 'ğŸš« O evento jÃ¡ atingiu o limite de vagas.', ephemeral: true });
    }

    evento.participantes.push(nick);

    const embed = EmbedBuilder.from(interaction.message.embeds[0]);
    embed.spliceFields(0, 1, { name: 'ğŸ‘¥ Participantes:', value: evento.participantes.join('\n') });
    embed.setDescription(`**Tipo:** ${evento.tipo}\n**HorÃ¡rio:** ${evento.horario}\n**DescriÃ§Ã£o:** ${evento.descricao}\n**Vagas:** ${evento.vagas - evento.participantes.length} restantes`);

    await interaction.update({ embeds: [embed] });
  }

  // --- CONTROLE DE EVENTO (SUPERIOR) ---
  if (interaction.isButton() && (interaction.customId.startsWith('iniciar_') || interaction.customId.startsWith('pausar_') || interaction.customId.startsWith('finalizar_'))) {
    const evento = eventosAtivos.get(interaction.message.id);
    if (!evento) return interaction.reply({ content: 'âŒ Evento nÃ£o encontrado.', ephemeral: true });

    if (interaction.user.id !== evento.criador && !interaction.member.roles.cache.some(r => r.name === 'Superior')) {
      return interaction.reply({ content: 'ğŸš« Apenas o criador ou Superiores podem controlar o evento.', ephemeral: true });
    }

    if (interaction.customId.startsWith('iniciar_')) {
      evento.iniciado = true;
      evento.tempoInicio = Date.now();
      return interaction.reply({ content: 'â–¶ï¸ Evento iniciado com sucesso!', ephemeral: true });
    }

    if (interaction.customId.startsWith('pausar_')) {
      if (!evento.iniciado) return interaction.reply({ content: 'âš ï¸ O evento ainda nÃ£o foi iniciado.', ephemeral: true });
      evento.pausas.push(Date.now());
      return interaction.reply({ content: 'â¸ï¸ Evento pausado.', ephemeral: true });
    }

    if (interaction.customId.startsWith('finalizar_')) {
      const duracao = evento.tempoInicio ? Math.round((Date.now() - evento.tempoInicio) / 60000) : 0;
      const embed = new EmbedBuilder()
        .setColor('#00ff88')
        .setTitle('ğŸ Evento Finalizado')
        .setDescription(`**Tipo:** ${evento.tipo}\n**DuraÃ§Ã£o:** ${duracao} minutos\n**Pausas:** ${evento.pausas.length}\n\nğŸ‘¥ **Participantes:**\n${evento.participantes.join('\n') || 'Nenhum'}`)
        .setFooter({ text: `Encerrado por ${interaction.user.tag}` })
        .setTimestamp();

      await interaction.message.edit({ embeds: [embed], components: [] });
      eventosAtivos.delete(interaction.message.id);
      return interaction.reply({ content: 'ğŸ Evento finalizado e registrado!', ephemeral: true });
    }
  }
});

client.login(process.env.DISCORD_TOKEN);
