// ======================
// ğŸ”¥ SISTEMA DE BATE-PONTO
// ======================

import {
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
  EmbedBuilder,
  Events,
} from "discord.js";

// Canal onde o sistema de ponto serÃ¡ usado
const PONTO_CHANNEL_NAME = "ğŸ”¥ãƒ»bate-ponto";
const CARGO_MLC = "MLC";

// Estrutura para guardar dados temporÃ¡rios dos pontos
const pontosAtivos = new Map();

// FunÃ§Ã£o para formatar milissegundos em â€œ1h 43minâ€
function formatarTempo(ms) {
  const totalMin = Math.floor(ms / 60000);
  const horas = Math.floor(totalMin / 60);
  const minutos = totalMin % 60;
  if (horas > 0) return `${horas}h ${minutos}min`;
  return `${minutos}min`;
}

// Envia os botÃµes fixos quando o bot ligar
client.once(Events.ClientReady, async () => {
  const canalPonto = client.channels.cache.find(
    (c) => c.name === PONTO_CHANNEL_NAME
  );
  if (!canalPonto) return console.log("Canal ğŸ”¥ãƒ»bate-ponto nÃ£o encontrado.");

  const embed = new EmbedBuilder()
    .setColor("Yellow")
    .setTitle("ğŸ”¥ Sistema de Bate-Ponto MLC")
    .setDescription(
      "Clique nos botÃµes abaixo para **iniciar, pausar ou encerrar** seu ponto.\n\nSomente membros com cargo `MLC` podem usar."
    )
    .setFooter({ text: "MLC â€¢ Sistema de ponto automÃ¡tico" });

  const botoes = new ActionRowBuilder().addComponents(
    new ButtonBuilder()
      .setCustomId("ponto_iniciar")
      .setLabel("ğŸŸ¢ Iniciar Ponto")
      .setStyle(ButtonStyle.Success),
    new ButtonBuilder()
      .setCustomId("ponto_pausar")
      .setLabel("â¸ï¸ Pausar")
      .setStyle(ButtonStyle.Secondary),
    new ButtonBuilder()
      .setCustomId("ponto_encerrar")
      .setLabel("ğŸ”´ Encerrar")
      .setStyle(ButtonStyle.Danger)
  );

  await canalPonto.send({ embeds: [embed], components: [botoes] });
  console.log("âœ… BotÃµes de bate-ponto enviados com sucesso.");
});

// Listener de interaÃ§Ãµes de botÃ£o
client.on(Events.InteractionCreate, async (interaction) => {
  if (!interaction.isButton()) return;

  const membro = interaction.member;
  if (!membro.roles.cache.some((r) => r.name === CARGO_MLC)) {
    return interaction.reply({
      content: "ğŸš« VocÃª nÃ£o tem permissÃ£o para usar o sistema de ponto.",
      ephemeral: true,
    });
  }

  const agora = Date.now();

  // Iniciar ponto
  if (interaction.customId === "ponto_iniciar") {
    if (pontosAtivos.has(membro.id)) {
      return interaction.reply({
        content: "âš ï¸ VocÃª jÃ¡ tem um ponto ativo!",
        ephemeral: true,
      });
    }

    const embed = new EmbedBuilder()
      .setColor("Yellow")
      .setTitle("ğŸ“ Ponto em andamento")
      .setDescription(
        `ğŸ‘¤ Membro: ${membro}\nğŸ• InÃ­cio: <t:${Math.floor(
          agora / 1000
        )}:t>\nâ¸ï¸ Pausas: 0\nâ° Tempo total: 0min`
      )
      .setFooter({ text: "Clique nos botÃµes para pausar ou encerrar." });

    const botoes = new ActionRowBuilder().addComponents(
      new ButtonBuilder()
        .setCustomId(`pausar_${membro.id}`)
        .setLabel("â¸ï¸ Pausar")
        .setStyle(ButtonStyle.Secondary),
      new ButtonBuilder()
        .setCustomId(`encerrar_${membro.id}`)
        .setLabel("ğŸ”´ Encerrar")
        .setStyle(ButtonStyle.Danger)
    );

    const msg = await interaction.reply({
      embeds: [embed],
      components: [botoes],
      fetchReply: true,
    });

    pontosAtivos.set(membro.id, {
      inicio: agora,
      pausas: 0,
      tempoPausado: 0,
      pausado: false,
      msgId: msg.id,
      canalId: msg.channelId,
    });
  }

  // Pausar ponto
  if (interaction.customId.startsWith("pausar_")) {
    const id = interaction.customId.split("_")[1];
    if (membro.id !== id)
      return interaction.reply({
        content: "ğŸš« Esse ponto nÃ£o Ã© seu!",
        ephemeral: true,
      });

    const ponto = pontosAtivos.get(id);
    if (!ponto)
      return interaction.reply({
        content: "âš ï¸ Nenhum ponto ativo encontrado.",
        ephemeral: true,
      });

    if (!ponto.pausado) {
      // Iniciar pausa
      ponto.pausado = true;
      ponto.pausaInicio = agora;
      ponto.pausas += 1;
      interaction.update({
        embeds: [
          new EmbedBuilder()
            .setColor("Orange")
            .setTitle("â¸ï¸ Ponto pausado")
            .setDescription(
              `ğŸ‘¤ Membro: ${membro}\nğŸ• InÃ­cio: <t:${Math.floor(
                ponto.inicio / 1000
              )}:t>\nâ¸ï¸ Pausas: ${ponto.pausas}\nğŸ•“ Tempo pausado: ${
                ponto.tempoPausado / 60000
              }min`
            ),
        ],
      });
    } else {
      // Retomar do pausa
      const tempoPausa = agora - ponto.pausaInicio;
      ponto.pausado = false;
      ponto.tempoPausado += tempoPausa;
      interaction.update({
        embeds: [
          new EmbedBuilder()
            .setColor("Yellow")
            .setTitle("ğŸ“ Ponto retomado")
            .setDescription(
              `ğŸ‘¤ Membro: ${membro}\nğŸ• InÃ­cio: <t:${Math.floor(
                ponto.inicio / 1000
              )}:t>\nâ¸ï¸ Pausas: ${ponto.pausas}\nğŸ•“ Tempo pausado: ${formatarTempo(
                ponto.tempoPausado
              )}`
            ),
        ],
      });
    }
  }

  // Encerrar ponto
  if (interaction.customId.startsWith("encerrar_")) {
    const id = interaction.customId.split("_")[1];
    if (membro.id !== id)
      return interaction.reply({
        content: "ğŸš« Esse ponto nÃ£o Ã© seu!",
        ephemeral: true,
      });

    const ponto = pontosAtivos.get(id);
    if (!ponto)
      return interaction.reply({
        content: "âš ï¸ Nenhum ponto ativo encontrado.",
        ephemeral: true,
      });

    const tempoTotal = agora - ponto.inicio - ponto.tempoPausado;
    const embed = new EmbedBuilder()
      .setColor("Yellow")
      .setTitle("âœ… Ponto encerrado")
      .setDescription(
        `ğŸ‘¤ Membro: ${membro}\nğŸ• InÃ­cio: <t:${Math.floor(
          ponto.inicio / 1000
        )}:t>\nâ¸ï¸ Pausas: ${ponto.pausas} vezes (${formatarTempo(
          ponto.tempoPausado
        )} total)\nâ° Tempo total de serviÃ§o: ${formatarTempo(
          tempoTotal
        )}\nğŸ“… Data: <t:${Math.floor(agora / 1000)}:d>`
      );

    interaction.update({
      embeds: [embed],
      components: [],
    });

    pontosAtivos.delete(id);
  }
});
